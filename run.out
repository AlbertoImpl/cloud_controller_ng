Using postgres
 psql -q -h localhost -p 5432 -U postgres -c 'drop database if exists cc_test_2;'
 psql -q -h localhost -p 5432 -U postgres -c 'drop database if exists cc_test_8;'
 psql -q -h localhost -p 5432 -U postgres -c 'drop database if exists cc_test_7;'
 psql -q -h localhost -p 5432 -U postgres -c 'drop database if exists cc_test_3;'
 psql -q -h localhost -p 5432 -U postgres -c 'drop database if exists cc_test_6;'
 psql -q -h localhost -p 5432 -U postgres -c 'drop database if exists cc_test_4;'
 psql -q -h localhost -p 5432 -U postgres -c 'drop database if exists cc_test_5;'
 psql -q -h localhost -p 5432 -U postgres -c 'drop database if exists cc_test_;'
 psql -q -h localhost -p 5432 -U postgres -c 'create database cc_test_6;'
 psql -q -h localhost -p 5432 -U postgres -c 'create database cc_test_;'
 psql -q -h localhost -p 5432 -U postgres -c 'create database cc_test_8;'
 psql -q -h localhost -p 5432 -U postgres -c 'create database cc_test_7;'
 psql -q -h localhost -p 5432 -U postgres -c 'create database cc_test_5;'
 psql -q -h localhost -p 5432 -U postgres -c 'create database cc_test_4;'
 psql -q -h localhost -p 5432 -U postgres -c 'create database cc_test_3;'
 psql -q -h localhost -p 5432 -U postgres -c 'create database cc_test_2;'
 psql -q -h localhost -p 5432 -U postgres -d cc_test_8 -c 'CREATE EXTENSION IF NOT EXISTS citext; CREATE EXTENSION IF NOT EXISTS "uuid-ossp"; CREATE EXTENSION IF NOT EXISTS pgcrypto;'
 psql -q -h localhost -p 5432 -U postgres -d cc_test_6 -c 'CREATE EXTENSION IF NOT EXISTS citext; CREATE EXTENSION IF NOT EXISTS "uuid-ossp"; CREATE EXTENSION IF NOT EXISTS pgcrypto;'
 psql -q -h localhost -p 5432 -U postgres -d cc_test_ -c 'CREATE EXTENSION IF NOT EXISTS citext; CREATE EXTENSION IF NOT EXISTS "uuid-ossp"; CREATE EXTENSION IF NOT EXISTS pgcrypto;'
 psql -q -h localhost -p 5432 -U postgres -d cc_test_4 -c 'CREATE EXTENSION IF NOT EXISTS citext; CREATE EXTENSION IF NOT EXISTS "uuid-ossp"; CREATE EXTENSION IF NOT EXISTS pgcrypto;'
 psql -q -h localhost -p 5432 -U postgres -d cc_test_5 -c 'CREATE EXTENSION IF NOT EXISTS citext; CREATE EXTENSION IF NOT EXISTS "uuid-ossp"; CREATE EXTENSION IF NOT EXISTS pgcrypto;'
 psql -q -h localhost -p 5432 -U postgres -d cc_test_7 -c 'CREATE EXTENSION IF NOT EXISTS citext; CREATE EXTENSION IF NOT EXISTS "uuid-ossp"; CREATE EXTENSION IF NOT EXISTS pgcrypto;'
 psql -q -h localhost -p 5432 -U postgres -d cc_test_3 -c 'CREATE EXTENSION IF NOT EXISTS citext; CREATE EXTENSION IF NOT EXISTS "uuid-ossp"; CREATE EXTENSION IF NOT EXISTS pgcrypto;'
 psql -q -h localhost -p 5432 -U postgres -d cc_test_2 -c 'CREATE EXTENSION IF NOT EXISTS citext; CREATE EXTENSION IF NOT EXISTS "uuid-ossp"; CREATE EXTENSION IF NOT EXISTS pgcrypto;'
bundle exec parallel_rspec --test-options '--order rand' --single spec/integration/ -- spec
Using recorded test runtime
8 processes for 714 specs, ~ 89 specs per process

Randomized with seed 50659

Randomized with seed 32658
.........
Randomized with seed 18091
..
Randomized with seed 55266
..
Randomized with seed 15375
.
Randomized with seed 52884
......
Randomized with seed 13583
..
Randomized with seed 12668
.........................................................................................................................................................................................................................................................................................................................................................................................................................................................................
  1) VCAP::CloudController::Presenters::V3::AppEnvPresenter#to_hash presents the app environment variables as json
     Failure/Error:
       VCAP::CloudController::BuildpackLifecycleDataModel.create(
         buildpack: 'the-happiest-buildpack',
         stack: 'the-happiest-stack',
         app: app
       )

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/presenters/v3/app_env_presenter_spec.rb:16:in `block (2 levels) in <module:V3>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.........................................................................................
  2) Apps GET /v3/apps returns a paginated list of apps the user has access to
     Failure/Error:
       app_model1.lifecycle_data.update(
         buildpack: buildpack.name,
         stack:     stack.name
       )

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/apps_spec.rb:162:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F..................................................................................................................
  3) Apps PATCH /v3/apps/:guid/relationships/current_droplet creates audit.app.process.update events
     Failure/Error: app_model.lifecycle_data.buildpack = 'http://example.com/git'

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fe20dc9eef0>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/request/apps_spec.rb:868:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.......
  4) Apps PATCH /v3/apps/:guid/relationships/current_droplet assigns the current droplet of the app
     Failure/Error: app_model.lifecycle_data.buildpack = 'http://example.com/git'

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fe20c74a310>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/request/apps_spec.rb:868:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.......
  5) Apps PATCH /v3/apps/:guid/relationships/current_droplet creates audit.app.process.create events
     Failure/Error: app_model.lifecycle_data.buildpack = 'http://example.com/git'

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fe20f4b23c0>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/request/apps_spec.rb:868:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
.F.......
  6) Apps PATCH /v3/apps/:guid/relationships/current_droplet creates audit.app.process.delete events
     Failure/Error: app_model.lifecycle_data.buildpack = 'http://example.com/git'

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fe20cb793a0>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/request/apps_spec.rb:868:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F................
  7) Apps GET /v3/apps/:guid/relationships/current_droplet gets the current droplet relationship
     Failure/Error: droplet_model.buildpack_lifecycle_data.update(buildpack: 'http://buildpack.git.url.com', stack: 'stack-name')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/apps_spec.rb:776:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F..........................
  8) Apps GET /v3/apps/:guid/droplets/current gets the current droplet
     Failure/Error: droplet_model.buildpack_lifecycle_data.update(buildpack: 'http://buildpack.git.url.com', stack: 'stack-name')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/apps_spec.rb:819:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F..........
  9) Apps GET /v3/apps/:guid gets a specific app
     Failure/Error: app_model.lifecycle_data.buildpack = buildpack.name

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fe20e721bc0>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/request/apps_spec.rb:385:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.......
  10) Apps PUT /v3/apps/:guid/start starts the app
      Failure/Error: app_model.lifecycle_data.buildpack = 'http://example.com/git'

      NoMethodError:
        undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fe20e61f470>
        Did you mean?  buildpacks=
                       buildpacks
      # ./spec/request/apps_spec.rb:632:in `block (3 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F....................
  11) Apps PUT /v3/apps/:guid/stop stops the app
      Failure/Error: app_model.lifecycle_data.buildpack = 'http://example.com/git'

      NoMethodError:
        undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fe20fbea390>
        Did you mean?  buildpacks=
                       buildpacks
      # ./spec/request/apps_spec.rb:698:in `block (3 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.....................................................................................................................................................................................................................................................................................................................................................................................................................................
  1) VCAP::CloudController::BuildModel#lifecycle_data is a persistable hash
     Failure/Error: expect(build_model.reload.lifecycle_data.buildpack).to eq(lifecycle_data.buildpack)

     NoMethodError:
       undefined method `buildpack' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fa4cab0fbf0>
       Did you mean?  buildpacks
                      buildpacks=
     # ./spec/unit/models/runtime/v3/persistence/build_model_spec.rb:54:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
  1) VCAP::CloudController::Presenters::V3::AppPresenter#to_hash presents the app as json
     Failure/Error:
       app.lifecycle_data.update(
         buildpack: 'git://user:pass@github.com/repo',
         stack: 'the-happiest-stack',
       )

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/presenters/v3/app_presenter_spec.rb:14:in `block (2 levels) in <module:V3>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F..........................................................................................................
  2) Droplets GET /v3/droplets list all droplets with a buildpack lifecycle
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:172:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.........
  3) Droplets GET /v3/droplets faceted list filters by organization guids
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:172:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F................
  4) Droplets GET /v3/droplets faceted list filters by app_guids
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:172:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.........
  5) Droplets GET /v3/droplets faceted list filters by space guids that the developer has access to
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:172:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.........
  6) Droplets GET /v3/droplets faceted list filters by states
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:172:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.............
  7) Droplets GET /v3/droplets faceted list filters by guids
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:172:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.........
  8) Droplets GET /v3/droplets when a droplet does not have a buildpack lifecycle is excluded
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:172:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F...............
  9) Droplets GET /v3/apps/:guid/droplets list all droplets with a buildpack lifecycle
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:412:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
.F.......
  10) Droplets GET /v3/apps/:guid/droplets filters by states
      Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

      Sequel::MassAssignmentRestriction:
        method buildpack= doesn't exist
      # ./spec/request/droplets_spec.rb:412:in `block (3 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F...................
  11) Droplets POST /v3/droplets/:guid/copy copies a droplet
      Failure/Error: og_droplet.buildpack_lifecycle_data.update(buildpack: 'http://buildpack.git.url.com', stack: 'stack-name')

      Sequel::MassAssignmentRestriction:
        method buildpack= doesn't exist
      # ./spec/request/droplets_spec.rb:659:in `block (3 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F...............................
  12) Droplets GET /v3/droplets/:guid when the droplet has a buildpack lifecycle redacts information for auditors
      Failure/Error: droplet_model.buildpack_lifecycle_data.update(buildpack: 'http://buildpack.git.url.com', stack: 'stack-name')

      Sequel::MassAssignmentRestriction:
        method buildpack= doesn't exist
      # ./spec/request/droplets_spec.rb:34:in `block (4 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F............
  13) Droplets GET /v3/droplets/:guid when the droplet has a buildpack lifecycle gets a droplet
      Failure/Error: droplet_model.buildpack_lifecycle_data.update(buildpack: 'http://buildpack.git.url.com', stack: 'stack-name')

      Sequel::MassAssignmentRestriction:
        method buildpack= doesn't exist
      # ./spec/request/droplets_spec.rb:34:in `block (4 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.......
  14) Droplets GET /v3/packages/:guid/droplets list all droplets with a buildpack lifecycle
      Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

      Sequel::MassAssignmentRestriction:
        method buildpack= doesn't exist
      # ./spec/request/droplets_spec.rb:544:in `block (3 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F......
  15) Droplets GET /v3/packages/:guid/droplets filters by states
      Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

      Sequel::MassAssignmentRestriction:
        method buildpack= doesn't exist
      # ./spec/request/droplets_spec.rb:544:in `block (3 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F..............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
  2) VCAP::CloudController::AppsController staging when app will be staged returns X-App-Staging-Log header with staging log url
     Failure/Error: expect(last_response.status).to eq(201), last_response.body

       {
         "error_code": "UnknownError",
         "description": "An unknown error occurred.",
         "code": 10001,
         "test_mode_info": {
           "description": "undefined method `custom?' for nil:NilClass",
           "error_code": "CF-custom?",
           "backtrace": [
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/lib/cloud_controller/backends/stagers.rb:24:in `validate_app'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/app/actions/v2/app_stage.rb:9:in `stage'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/app/actions/v2/app_update.rb:105:in `stage'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/app/actions/v2/app_update.rb:38:in `update'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/app/controllers/runtime/apps_controller.rb:246:in `update'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/app/controllers/base/base_controller.rb:79:in `dispatch'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/lib/cloud_controller/rest_controller/routes.rb:16:in `block in define_route'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1610:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1610:in `block in compile!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:975:in `block (3 levels) in route!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:994:in `route_eval'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:975:in `block (2 levels) in route!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1015:in `block in process_route'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1013:in `catch'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1013:in `process_route'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:973:in `block in route!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:972:in `each'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:972:in `route!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:985:in `route!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1085:in `block in dispatch!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1067:in `block in invoke'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1067:in `catch'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1067:in `invoke'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1082:in `dispatch!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:907:in `block in call!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1067:in `block in invoke'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1067:in `catch'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1067:in `invoke'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:907:in `call!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:895:in `call'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/spec/support/fake_nginx_reverse_proxy.rb:22:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-protection-1.5.3/lib/rack/protection/xss_header.rb:18:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-protection-1.5.3/lib/rack/protection/path_traversal.rb:16:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-protection-1.5.3/lib/rack/protection/json_csrf.rb:18:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-protection-1.5.3/lib/rack/protection/base.rb:49:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-protection-1.5.3/lib/rack/protection/base.rb:49:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-protection-1.5.3/lib/rack/protection/frame_options.rb:31:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-1.6.8/lib/rack/nulllogger.rb:9:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-1.6.8/lib/rack/head.rb:13:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:182:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:2013:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-test-0.6.3/lib/rack/mock_session.rb:30:in `request'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-test-0.6.3/lib/rack/test.rb:244:in `process_request'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-test-0.6.3/lib/rack/test.rb:76:in `put'",
             "/Users/pivotal/.rubies/ruby-2.3.3/lib/ruby/2.3.0/forwardable.rb:189:in `put'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/spec/unit/controllers/runtime/apps_controller_spec.rb:1625:in `block (4 levels) in <module:CloudController>'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:236:in `instance_exec'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:236:in `block in run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:478:in `block in with_around_and_singleton_context_hooks'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:435:in `block in with_around_example_hooks'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/hooks.rb:478:in `block in run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/hooks.rb:618:in `block in run_around_example_hooks_for'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:320:in `call'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/spec/support/database_isolation.rb:18:in `cleanly'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:425:in `instance_exec'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:425:in `instance_exec'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/hooks.rb:389:in `execute_with'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/hooks.rb:620:in `block (2 levels) in run_around_example_hooks_for'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:320:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/hooks.rb:621:in `run_around_example_hooks_for'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/hooks.rb:478:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:435:in `with_around_example_hooks'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:478:in `with_around_and_singleton_context_hooks'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:233:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:581:in `block in run_examples'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:577:in `map'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:577:in `run_examples'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:543:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:544:in `block in run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:544:in `map'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:544:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:544:in `block in run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:544:in `map'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:544:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:119:in `block (3 levels) in run_specs'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:119:in `map'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:119:in `block (2 levels) in run_specs'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/configuration.rb:1680:in `with_suite_hooks'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:118:in `block in run_specs'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/reporter.rb:77:in `report'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:117:in `run_specs'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:93:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:78:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:45:in `invoke'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/exe/rspec:4:in `<top (required)>'",
             "/Users/pivotal/.gem/ruby/2.3.3/bin/rspec:22:in `load'",
             "/Users/pivotal/.gem/ruby/2.3.3/bin/rspec:22:in `<top (required)>'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli/exec.rb:74:in `load'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli/exec.rb:74:in `kernel_load'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli/exec.rb:27:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli.rb:360:in `exec'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/vendor/thor/lib/thor/command.rb:27:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/vendor/thor/lib/thor/invocation.rb:126:in `invoke_command'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/vendor/thor/lib/thor.rb:369:in `dispatch'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli.rb:20:in `dispatch'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/vendor/thor/lib/thor/base.rb:444:in `start'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli.rb:10:in `start'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/exe/bundle:35:in `block in <top (required)>'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/friendly_errors.rb:121:in `with_friendly_errors'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/exe/bundle:27:in `<top (required)>'",
             "/Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'",
             "/Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'"
           ]
         }
       }
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:1626:in `block (4 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:18:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F............................................................................................................................................................................................................................................................................................................................................................................................................................................
  3) VCAP::CloudController::AppsController create app creates the app
     Failure/Error: expect(v2_app.buildpack.url).to eq('http://example.com/buildpack')

     NoMethodError:
       undefined method `url' for "http://example.com/buildpack":String
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:362:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F..................
  4) VCAP::CloudController::AppsController create app creating a buildpack app creates the app correctly
     Failure/Error: expect(v2_app.buildpack.url).to eq('http://example.com/buildpack')

     NoMethodError:
       undefined method `url' for "http://example.com/buildpack":String
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:392:in `block (4 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F...................................................................................................................................................................................
  5) VCAP::CloudController::AppsController update app updates the app
     Failure/Error: expect(v2_app.buildpack.url).to eq('http://example.com/buildpack')

     NoMethodError:
       undefined method `url' for "http://example.com/buildpack":String
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:803:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.........................................................................................................................................................................................................................................................................................................................................
  6) VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does NOT allow a public http url
     Failure/Error: app_obj.app.lifecycle_data.update(buildpack: Buildpack.make.name)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:816:in `block (4 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F......
  7) VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does NOT allow a public git url
     Failure/Error: app_obj.app.lifecycle_data.update(buildpack: Buildpack.make.name)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:816:in `block (4 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F......
  8) VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does allow a buildpack name
     Failure/Error: app_obj.app.lifecycle_data.update(buildpack: Buildpack.make.name)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:816:in `block (4 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F...........
  9) VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does not allow a private git url with ssh schema
     Failure/Error: app_obj.app.lifecycle_data.update(buildpack: Buildpack.make.name)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:816:in `block (4 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.............
  10) VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does not allow a private git url
      Failure/Error: app_obj.app.lifecycle_data.update(buildpack: Buildpack.make.name)

      Sequel::MassAssignmentRestriction:
        method buildpack= doesn't exist
      # ./spec/unit/controllers/runtime/apps_controller_spec.rb:816:in `block (4 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.......................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
  1) VCAP::CloudController::StagingCompletionController /build_completed propagates api errors from staging_response
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F............
  2) VCAP::CloudController::StagingCompletionController /build_completed calls the stager with the build and response
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F..........
  3) VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS propagates other errors from staging_response
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F...............
  4) VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS propagates api errors from staging_response
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F............
  5) VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS emits metrics for staging success
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F............
  6) VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS calls the stager with the droplet and response
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F..........
  7) VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS when staging failed emits metrics for staging failure
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F..........
  8) VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS when staging failed passes down the sanitized version of the error to the diego stager
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F...........
  9) VCAP::CloudController::StagingCompletionController /build_completed authentication when using valid credentials succeeds
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F..........
  10) VCAP::CloudController::StagingCompletionController /build_completed authentication when using invalid credentials fails with authenticatiom required
      Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

      NoMethodError:
        undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
        Did you mean?  buildpacks=
                       buildpacks
      # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F............
  11) VCAP::CloudController::StagingCompletionController /build_completed authentication when missing authentication fails with authentication required
      Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

      NoMethodError:
        undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
        Did you mean?  buildpacks=
                       buildpacks
      # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F..............
  12) VCAP::CloudController::StagingCompletionController /build_completed validation when sending invalid json fails with a 400
      Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

      NoMethodError:
        undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
        Did you mean?  buildpacks=
                       buildpacks
      # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
.F..........
  13) VCAP::CloudController::StagingCompletionController /build_completed when the build does not exist returns 404
      Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

      NoMethodError:
        undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
        Did you mean?  buildpacks=
                       buildpacks
      # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F..........
  14) VCAP::CloudController::StagingCompletionController /build_completed when the start query param has a true value requests staging_complete with start
      Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

      NoMethodError:
        undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
        Did you mean?  buildpacks=
                       buildpacks
      # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.........................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
  12) VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute uses a salt, so that every row is encrypted with a different key
      Failure/Error: model.update(encrypted_attr => value_to_encrypt)

      Sequel::ValidationFailed:
        base Invalid buildpack-lifecycle-buildpack
      Shared Example Group: "a model with an encrypted attribute" called from ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb:7
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:11:in `block in new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `tap'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:17:in `block (2 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F
  13) VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute must have a salt of length 8
      Failure/Error: model.update(encrypted_attr => value_to_encrypt)

      Sequel::ValidationFailed:
        base Invalid buildpack-lifecycle-buildpack
      Shared Example Group: "a model with an encrypted attribute" called from ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb:7
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:11:in `block in new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `tap'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:17:in `block (2 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.
  14) VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute is encrypted before being written to the database
      Failure/Error: model.update(encrypted_attr => value_to_encrypt)

      Sequel::ValidationFailed:
        base Invalid buildpack-lifecycle-buildpack
      Shared Example Group: "a model with an encrypted attribute" called from ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb:7
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:11:in `block in new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `tap'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:17:in `block (2 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.
  15) VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute uses the db_encryption_key from the config file
      Failure/Error: model.update(encrypted_attr => value_to_encrypt)

      Sequel::ValidationFailed:
        base Invalid buildpack-lifecycle-buildpack
      Shared Example Group: "a model with an encrypted attribute" called from ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb:7
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:11:in `block in new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `tap'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:17:in `block (2 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F
  16) VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute is decrypted when it is read from the database
      Failure/Error: model.update(encrypted_attr => value_to_encrypt)

      Sequel::ValidationFailed:
        base Invalid buildpack-lifecycle-buildpack
      Shared Example Group: "a model with an encrypted attribute" called from ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb:7
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:11:in `block in new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `tap'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:17:in `block (2 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F..............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
  16) CloudController::Presenters::V2::AppPresenter#entity_hash buildpacks with a custom buildpack calls out to the UrlSecretObfuscator
      Failure/Error: expect(CloudController::UrlSecretObfuscator).to have_received(:obfuscate).exactly :once

        (CloudController::UrlSecretObfuscator (class)).obfuscate(*(any args))
            expected: 1 time with any arguments
            received: 0 times with any arguments
      # ./spec/unit/presenters/v2/app_presenter_spec.rb:127:in `block (5 levels) in <module:V2>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.................................................................................................................................................................................................................................................................................................................................
  1) VCAP::CloudController::ServiceInstanceDelete#delete when deprovisioning a service instance times out should mark the service instance as failed
     Failure/Error:
       expect(a_request(:delete, deprovision_url(service_instance_1))).
         to have_been_made.times(1)

       The request DELETE https://auth_username-274:auth_password-274@foo.com/url-332/v2/service_instances/54c09a54-e668-4158-9f25-c8e819edb01c?plan_id=08dabfe3-6097-497f-a90c-bbcc54de3ec1&service_id=1038c3aa-b203-4b23-8f76-e87f013f333b was expected to execute 1 time but it executed 0 times

       The following requests were made:

       DELETE https://auth_username-274:auth_password-274@foo.com/url-332/v2/service_instances/54c09a54-e668-4158-9f25-c8e819edb01c/service_bindings/09860c67-5482-401d-bf6f-bc31ba9d1b4f?plan_id=08dabfe3-6097-497f-a90c-bbcc54de3ec1&service_id=1038c3aa-b203-4b23-8f76-e87f013f333b with headers {'Accept'=>'application/json', 'Authorization'=>'Basic YXV0aF91c2VybmFtZS0yNzQ6YXV0aF9wYXNzd29yZC0yNzQ=', 'Date'=>'Fri, 07 Jul 2017 00:39:50 GMT', 'User-Agent'=>'HTTPClient/1.0 (2.8.2.4, ruby 2.3.3 (2016-11-21))', 'X-Api-Info-Location'=>'api2.vcap.me/v2/info', 'X-Broker-Api-Version'=>'2.12', 'X-Vcap-Request-Id'=>''} was made 1 time
       DELETE https://auth_username-274:auth_password-274@foo.com/url-332/v2/service_instances/54c09a54-e668-4158-9f25-c8e819edb01c/service_bindings/4187eb65-b284-44ba-a584-dad390150711?plan_id=08dabfe3-6097-497f-a90c-bbcc54de3ec1&service_id=1038c3aa-b203-4b23-8f76-e87f013f333b with headers {'Accept'=>'application/json', 'Authorization'=>'Basic YXV0aF91c2VybmFtZS0yNzQ6YXV0aF9wYXNzd29yZC0yNzQ=', 'Date'=>'Fri, 07 Jul 2017 00:39:51 GMT', 'User-Agent'=>'HTTPClient/1.0 (2.8.2.4, ruby 2.3.3 (2016-11-21))', 'X-Api-Info-Location'=>'api2.vcap.me/v2/info', 'X-Broker-Api-Version'=>'2.12', 'X-Vcap-Request-Id'=>''} was made 1 time

       ============================================================
     # ./spec/unit/actions/services/service_instance_delete_spec.rb:188:in `block (4 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F....................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
  1) VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_build buildpack builds when the build has BOTH an associated droplet and lifecycle data prefers the buildpack receipt info
     Failure/Error: buildpack_lifecycle_data: BuildpackLifecycleDataModel.make(buildpack: 'ruby_buildpack')

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/repositories/app_usage_event_repository_spec.rb:413:in `block (5 levels) in <module:Repositories>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F....
  2) VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_build buildpack builds when the build does NOT have an associated droplet but does have lifecycle data sets the event buildpack_name to the lifecycle data buildpack
     Failure/Error: buildpack_lifecycle_data: BuildpackLifecycleDataModel.make(buildpack: 'http://git.url.example.com')

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/repositories/app_usage_event_repository_spec.rb:366:in `block (5 levels) in <module:Repositories>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F.....
  3) VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_build buildpack builds when the build does NOT have an associated droplet but does have lifecycle data when buildpack lifecycle info contains credentials in buildpack url redacts credentials from the url
     Failure/Error: buildpack_lifecycle_data: BuildpackLifecycleDataModel.make(buildpack: 'http://git.url.example.com')

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/repositories/app_usage_event_repository_spec.rb:366:in `block (5 levels) in <module:Repositories>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F...................................................................................................................................................................
  4) VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_app when the DEA doesn't provide optional buildpack information will create an event that does not contain buildpack name or guid
     Failure/Error: app.app.lifecycle_data.update(buildpack: nil)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/repositories/app_usage_event_repository_spec.rb:137:in `block (4 levels) in <module:Repositories>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F..........................................
  5) VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_app when a custom buildpack is associated with the app will create an event with the buildpack url as the name
     Failure/Error: app.app.lifecycle_data.update(buildpack: buildpack_url)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/repositories/app_usage_event_repository_spec.rb:112:in `block (4 levels) in <module:Repositories>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F....
  6) VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_app when a custom buildpack is associated with the app will create an event without a buildpack guid
     Failure/Error: app.app.lifecycle_data.update(buildpack: buildpack_url)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/repositories/app_usage_event_repository_spec.rb:112:in `block (4 levels) in <module:Repositories>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F...........
  7) VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_app when a custom buildpack is associated with the app where there are user credentials in the buildpack url redacts them
     Failure/Error: app.app.lifecycle_data.update(buildpack: buildpack_url)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/repositories/app_usage_event_repository_spec.rb:112:in `block (4 levels) in <module:Repositories>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
F....................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
.
Failures:

  1) VCAP::CloudController::BuildModel#lifecycle_data is a persistable hash
     Failure/Error: expect(build_model.reload.lifecycle_data.buildpack).to eq(lifecycle_data.buildpack)

     NoMethodError:
       undefined method `buildpack' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fa4cab0fbf0>
       Did you mean?  buildpacks
                      buildpacks=
     # ./spec/unit/models/runtime/v3/persistence/build_model_spec.rb:54:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  2) Droplets GET /v3/droplets list all droplets with a buildpack lifecycle
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:172:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  3) Droplets GET /v3/droplets faceted list filters by organization guids
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:172:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  4) Droplets GET /v3/droplets faceted list filters by app_guids
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:172:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  5) Droplets GET /v3/droplets faceted list filters by space guids that the developer has access to
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:172:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  6) Droplets GET /v3/droplets faceted list filters by states
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:172:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  7) Droplets GET /v3/droplets faceted list filters by guids
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:172:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  8) Droplets GET /v3/droplets when a droplet does not have a buildpack lifecycle is excluded
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:172:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  9) Droplets GET /v3/apps/:guid/droplets list all droplets with a buildpack lifecycle
     Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/droplets_spec.rb:412:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  10) Droplets GET /v3/apps/:guid/droplets filters by states
      Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

      Sequel::MassAssignmentRestriction:
        method buildpack= doesn't exist
      # ./spec/request/droplets_spec.rb:412:in `block (3 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  11) Droplets POST /v3/droplets/:guid/copy copies a droplet
      Failure/Error: og_droplet.buildpack_lifecycle_data.update(buildpack: 'http://buildpack.git.url.com', stack: 'stack-name')

      Sequel::MassAssignmentRestriction:
        method buildpack= doesn't exist
      # ./spec/request/droplets_spec.rb:659:in `block (3 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  12) Droplets GET /v3/droplets/:guid when the droplet has a buildpack lifecycle redacts information for auditors
      Failure/Error: droplet_model.buildpack_lifecycle_data.update(buildpack: 'http://buildpack.git.url.com', stack: 'stack-name')

      Sequel::MassAssignmentRestriction:
        method buildpack= doesn't exist
      # ./spec/request/droplets_spec.rb:34:in `block (4 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  13) Droplets GET /v3/droplets/:guid when the droplet has a buildpack lifecycle gets a droplet
      Failure/Error: droplet_model.buildpack_lifecycle_data.update(buildpack: 'http://buildpack.git.url.com', stack: 'stack-name')

      Sequel::MassAssignmentRestriction:
        method buildpack= doesn't exist
      # ./spec/request/droplets_spec.rb:34:in `block (4 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  14) Droplets GET /v3/packages/:guid/droplets list all droplets with a buildpack lifecycle
      Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

      Sequel::MassAssignmentRestriction:
        method buildpack= doesn't exist
      # ./spec/request/droplets_spec.rb:544:in `block (3 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  15) Droplets GET /v3/packages/:guid/droplets filters by states
      Failure/Error: droplet1.buildpack_lifecycle_data.update(buildpack: buildpack.name, stack: 'stack-1')

      Sequel::MassAssignmentRestriction:
        method buildpack= doesn't exist
      # ./spec/request/droplets_spec.rb:544:in `block (3 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  16) CloudController::Presenters::V2::AppPresenter#entity_hash buildpacks with a custom buildpack calls out to the UrlSecretObfuscator
      Failure/Error: expect(CloudController::UrlSecretObfuscator).to have_received(:obfuscate).exactly :once

        (CloudController::UrlSecretObfuscator (class)).obfuscate(*(any args))
            expected: 1 time with any arguments
            received: 0 times with any arguments
      # ./spec/unit/presenters/v2/app_presenter_spec.rb:127:in `block (5 levels) in <module:V2>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
.....
Finished in 3 minutes 53.1 seconds (files took 10.81 seconds to load)
1458 examples, 16 failures

Failed examples:

rspec ./spec/unit/models/runtime/v3/persistence/build_model_spec.rb:53 # VCAP::CloudController::BuildModel#lifecycle_data is a persistable hash
rspec ./spec/request/droplets_spec.rb:176 # Droplets GET /v3/droplets list all droplets with a buildpack lifecycle
rspec ./spec/request/droplets_spec.rb:316 # Droplets GET /v3/droplets faceted list filters by organization guids
rspec ./spec/request/droplets_spec.rb:277 # Droplets GET /v3/droplets faceted list filters by app_guids
rspec ./spec/request/droplets_spec.rb:334 # Droplets GET /v3/droplets faceted list filters by space guids that the developer has access to
rspec ./spec/request/droplets_spec.rb:258 # Droplets GET /v3/droplets faceted list filters by states
rspec ./spec/request/droplets_spec.rb:295 # Droplets GET /v3/droplets faceted list filters by guids
rspec ./spec/request/droplets_spec.rb:245 # Droplets GET /v3/droplets when a droplet does not have a buildpack lifecycle is excluded
rspec ./spec/request/droplets_spec.rb:434 # Droplets GET /v3/apps/:guid/droplets list all droplets with a buildpack lifecycle
rspec ./spec/request/droplets_spec.rb:416 # Droplets GET /v3/apps/:guid/droplets filters by states
rspec ./spec/request/droplets_spec.rb:662 # Droplets POST /v3/droplets/:guid/copy copies a droplet
rspec ./spec/request/droplets_spec.rb:68 # Droplets GET /v3/droplets/:guid when the droplet has a buildpack lifecycle redacts information for auditors
rspec ./spec/request/droplets_spec.rb:37 # Droplets GET /v3/droplets/:guid when the droplet has a buildpack lifecycle gets a droplet
rspec ./spec/request/droplets_spec.rb:566 # Droplets GET /v3/packages/:guid/droplets list all droplets with a buildpack lifecycle
rspec ./spec/request/droplets_spec.rb:548 # Droplets GET /v3/packages/:guid/droplets filters by states
rspec ./spec/unit/presenters/v2/app_presenter_spec.rb:122 # CloudController::Presenters::V2::AppPresenter#entity_hash buildpacks with a custom buildpack calls out to the UrlSecretObfuscator

Randomized with seed 18091

............................................................................................................................................................................................................................................................................................................
....
Failures:

  1) VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_build buildpack builds when the build has BOTH an associated droplet and lifecycle data prefers the buildpack receipt info
     Failure/Error: buildpack_lifecycle_data: BuildpackLifecycleDataModel.make(buildpack: 'ruby_buildpack')

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/repositories/app_usage_event_repository_spec.rb:413:in `block (5 levels) in <module:Repositories>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  2) VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_build buildpack builds when the build does NOT have an associated droplet but does have lifecycle data sets the event buildpack_name to the lifecycle data buildpack
     Failure/Error: buildpack_lifecycle_data: BuildpackLifecycleDataModel.make(buildpack: 'http://git.url.example.com')

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/repositories/app_usage_event_repository_spec.rb:366:in `block (5 levels) in <module:Repositories>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  3) VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_build buildpack builds when the build does NOT have an associated droplet but does have lifecycle data when buildpack lifecycle info contains credentials in buildpack url redacts credentials from the url
     Failure/Error: buildpack_lifecycle_data: BuildpackLifecycleDataModel.make(buildpack: 'http://git.url.example.com')

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/repositories/app_usage_event_repository_spec.rb:366:in `block (5 levels) in <module:Repositories>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  4) VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_app when the DEA doesn't provide optional buildpack information will create an event that does not contain buildpack name or guid
     Failure/Error: app.app.lifecycle_data.update(buildpack: nil)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/repositories/app_usage_event_repository_spec.rb:137:in `block (4 levels) in <module:Repositories>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  5) VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_app when a custom buildpack is associated with the app will create an event with the buildpack url as the name
     Failure/Error: app.app.lifecycle_data.update(buildpack: buildpack_url)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/repositories/app_usage_event_repository_spec.rb:112:in `block (4 levels) in <module:Repositories>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  6) VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_app when a custom buildpack is associated with the app will create an event without a buildpack guid
     Failure/Error: app.app.lifecycle_data.update(buildpack: buildpack_url)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/repositories/app_usage_event_repository_spec.rb:112:in `block (4 levels) in <module:Repositories>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  7) VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_app when a custom buildpack is associated with the app where there are user credentials in the buildpack url redacts them
     Failure/Error: app.app.lifecycle_data.update(buildpack: buildpack_url)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/repositories/app_usage_event_repository_spec.rb:112:in `block (4 levels) in <module:Repositories>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
....
Finished in 3 minutes 58.7 seconds (files took 11.09 seconds to load)
2055 examples, 7 failures

Failed examples:

rspec ./spec/unit/repositories/app_usage_event_repository_spec.rb:417 # VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_build buildpack builds when the build has BOTH an associated droplet and lifecycle data prefers the buildpack receipt info
rspec ./spec/unit/repositories/app_usage_event_repository_spec.rb:370 # VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_build buildpack builds when the build does NOT have an associated droplet but does have lifecycle data sets the event buildpack_name to the lifecycle data buildpack
rspec ./spec/unit/repositories/app_usage_event_repository_spec.rb:384 # VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_build buildpack builds when the build does NOT have an associated droplet but does have lifecycle data when buildpack lifecycle info contains credentials in buildpack url redacts credentials from the url
rspec ./spec/unit/repositories/app_usage_event_repository_spec.rb:140 # VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_app when the DEA doesn't provide optional buildpack information will create an event that does not contain buildpack name or guid
rspec ./spec/unit/repositories/app_usage_event_repository_spec.rb:115 # VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_app when a custom buildpack is associated with the app will create an event with the buildpack url as the name
rspec ./spec/unit/repositories/app_usage_event_repository_spec.rb:129 # VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_app when a custom buildpack is associated with the app will create an event without a buildpack guid
rspec ./spec/unit/repositories/app_usage_event_repository_spec.rb:123 # VCAP::CloudController::Repositories::AppUsageEventRepository#create_from_app when a custom buildpack is associated with the app where there are user credentials in the buildpack url redacts them

Randomized with seed 52884

.........................................................................................................................
.
Finished in 4 minutes 0 seconds (files took 10.87 seconds to load)
1510 examples, 0 failures

Randomized with seed 55266

..............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
..
Failures:

  1) VCAP::CloudController::Presenters::V3::AppEnvPresenter#to_hash presents the app environment variables as json
     Failure/Error:
       VCAP::CloudController::BuildpackLifecycleDataModel.create(
         buildpack: 'the-happiest-buildpack',
         stack: 'the-happiest-stack',
         app: app
       )

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/presenters/v3/app_env_presenter_spec.rb:16:in `block (2 levels) in <module:V3>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  2) Apps GET /v3/apps returns a paginated list of apps the user has access to
     Failure/Error:
       app_model1.lifecycle_data.update(
         buildpack: buildpack.name,
         stack:     stack.name
       )

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/apps_spec.rb:162:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  3) Apps PATCH /v3/apps/:guid/relationships/current_droplet creates audit.app.process.update events
     Failure/Error: app_model.lifecycle_data.buildpack = 'http://example.com/git'

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fe20dc9eef0>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/request/apps_spec.rb:868:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  4) Apps PATCH /v3/apps/:guid/relationships/current_droplet assigns the current droplet of the app
     Failure/Error: app_model.lifecycle_data.buildpack = 'http://example.com/git'

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fe20c74a310>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/request/apps_spec.rb:868:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  5) Apps PATCH /v3/apps/:guid/relationships/current_droplet creates audit.app.process.create events
     Failure/Error: app_model.lifecycle_data.buildpack = 'http://example.com/git'

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fe20f4b23c0>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/request/apps_spec.rb:868:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  6) Apps PATCH /v3/apps/:guid/relationships/current_droplet creates audit.app.process.delete events
     Failure/Error: app_model.lifecycle_data.buildpack = 'http://example.com/git'

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fe20cb793a0>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/request/apps_spec.rb:868:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  7) Apps GET /v3/apps/:guid/relationships/current_droplet gets the current droplet relationship
     Failure/Error: droplet_model.buildpack_lifecycle_data.update(buildpack: 'http://buildpack.git.url.com', stack: 'stack-name')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/apps_spec.rb:776:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  8) Apps GET /v3/apps/:guid/droplets/current gets the current droplet
     Failure/Error: droplet_model.buildpack_lifecycle_data.update(buildpack: 'http://buildpack.git.url.com', stack: 'stack-name')

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/request/apps_spec.rb:819:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  9) Apps GET /v3/apps/:guid gets a specific app
     Failure/Error: app_model.lifecycle_data.buildpack = buildpack.name

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fe20e721bc0>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/request/apps_spec.rb:385:in `block (3 levels) in <top (required)>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  10) Apps PUT /v3/apps/:guid/start starts the app
      Failure/Error: app_model.lifecycle_data.buildpack = 'http://example.com/git'

      NoMethodError:
        undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fe20e61f470>
        Did you mean?  buildpacks=
                       buildpacks
      # ./spec/request/apps_spec.rb:632:in `block (3 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  11) Apps PUT /v3/apps/:guid/stop stops the app
      Failure/Error: app_model.lifecycle_data.buildpack = 'http://example.com/git'

      NoMethodError:
        undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel:0x007fe20fbea390>
        Did you mean?  buildpacks=
                       buildpacks
      # ./spec/request/apps_spec.rb:698:in `block (3 levels) in <top (required)>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  12) VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute uses a salt, so that every row is encrypted with a different key
      Failure/Error: model.update(encrypted_attr => value_to_encrypt)

      Sequel::ValidationFailed:
        base Invalid buildpack-lifecycle-buildpack
      Shared Example Group: "a model with an encrypted attribute" called from ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb:7
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:11:in `block in new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `tap'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:17:in `block (2 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  13) VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute must have a salt of length 8
      Failure/Error: model.update(encrypted_attr => value_to_encrypt)

      Sequel::ValidationFailed:
        base Invalid buildpack-lifecycle-buildpack
      Shared Example Group: "a model with an encrypted attribute" called from ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb:7
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:11:in `block in new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `tap'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:17:in `block (2 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  14) VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute is encrypted before being written to the database
      Failure/Error: model.update(encrypted_attr => value_to_encrypt)

      Sequel::ValidationFailed:
        base Invalid buildpack-lifecycle-buildpack
      Shared Example Group: "a model with an encrypted attribute" called from ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb:7
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:11:in `block in new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `tap'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:17:in `block (2 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  15) VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute uses the db_encryption_key from the config file
      Failure/Error: model.update(encrypted_attr => value_to_encrypt)

      Sequel::ValidationFailed:
        base Invalid buildpack-lifecycle-buildpack
      Shared Example Group: "a model with an encrypted attribute" called from ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb:7
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:11:in `block in new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `tap'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:17:in `block (2 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  16) VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute is decrypted when it is read from the database
      Failure/Error: model.update(encrypted_attr => value_to_encrypt)

      Sequel::ValidationFailed:
        base Invalid buildpack-lifecycle-buildpack
      Shared Example Group: "a model with an encrypted attribute" called from ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb:7
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:11:in `block in new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `tap'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:10:in `new_model'
      # ./spec/support/shared_examples/models/encrypted_attribute.rb:17:in `block (2 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

Finished in 4 minutes 10.6 seconds (files took 11.29 seconds to load)
2485 examples, 16 failures

Failed examples:

rspec ./spec/unit/presenters/v3/app_env_presenter_spec.rb:34 # VCAP::CloudController::Presenters::V3::AppEnvPresenter#to_hash presents the app environment variables as json
rspec ./spec/request/apps_spec.rb:157 # Apps GET /v3/apps returns a paginated list of apps the user has access to
rspec ./spec/request/apps_spec.rb:972 # Apps PATCH /v3/apps/:guid/relationships/current_droplet creates audit.app.process.update events
rspec ./spec/request/apps_spec.rb:873 # Apps PATCH /v3/apps/:guid/relationships/current_droplet assigns the current droplet of the app
rspec ./spec/request/apps_spec.rb:920 # Apps PATCH /v3/apps/:guid/relationships/current_droplet creates audit.app.process.create events
rspec ./spec/request/apps_spec.rb:1013 # Apps PATCH /v3/apps/:guid/relationships/current_droplet creates audit.app.process.delete events
rspec ./spec/request/apps_spec.rb:781 # Apps GET /v3/apps/:guid/relationships/current_droplet gets the current droplet relationship
rspec ./spec/request/apps_spec.rb:824 # Apps GET /v3/apps/:guid/droplets/current gets the current droplet
rspec ./spec/request/apps_spec.rb:374 # Apps GET /v3/apps/:guid gets a specific app
rspec ./spec/request/apps_spec.rb:623 # Apps PUT /v3/apps/:guid/start starts the app
rspec ./spec/request/apps_spec.rb:689 # Apps PUT /v3/apps/:guid/stop stops the app
rspec ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb[1:1:4] # VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute uses a salt, so that every row is encrypted with a different key
rspec ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb[1:1:5] # VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute must have a salt of length 8
rspec ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb[1:1:1] # VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute is encrypted before being written to the database
rspec ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb[1:1:3] # VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute uses the db_encryption_key from the config file
rspec ./spec/unit/models/runtime/v3/persistence/buildpack_lifecycle_buildpack_model_spec.rb[1:1:2] # VCAP::CloudController::BuildpackLifecycleBuildpackModel behaves like a model with an encrypted attribute is decrypted when it is read from the database

Randomized with seed 13583

.................................................
.
Failures:

  1) VCAP::CloudController::Presenters::V3::AppPresenter#to_hash presents the app as json
     Failure/Error:
       app.lifecycle_data.update(
         buildpack: 'git://user:pass@github.com/repo',
         stack: 'the-happiest-stack',
       )

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/presenters/v3/app_presenter_spec.rb:14:in `block (2 levels) in <module:V3>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  2) VCAP::CloudController::AppsController staging when app will be staged returns X-App-Staging-Log header with staging log url
     Failure/Error: expect(last_response.status).to eq(201), last_response.body

       {
         "error_code": "UnknownError",
         "description": "An unknown error occurred.",
         "code": 10001,
         "test_mode_info": {
           "description": "undefined method `custom?' for nil:NilClass",
           "error_code": "CF-custom?",
           "backtrace": [
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/lib/cloud_controller/backends/stagers.rb:24:in `validate_app'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/app/actions/v2/app_stage.rb:9:in `stage'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/app/actions/v2/app_update.rb:105:in `stage'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/app/actions/v2/app_update.rb:38:in `update'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/app/controllers/runtime/apps_controller.rb:246:in `update'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/app/controllers/base/base_controller.rb:79:in `dispatch'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/lib/cloud_controller/rest_controller/routes.rb:16:in `block in define_route'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1610:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1610:in `block in compile!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:975:in `block (3 levels) in route!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:994:in `route_eval'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:975:in `block (2 levels) in route!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1015:in `block in process_route'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1013:in `catch'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1013:in `process_route'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:973:in `block in route!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:972:in `each'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:972:in `route!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:985:in `route!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1085:in `block in dispatch!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1067:in `block in invoke'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1067:in `catch'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1067:in `invoke'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1082:in `dispatch!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:907:in `block in call!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1067:in `block in invoke'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1067:in `catch'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:1067:in `invoke'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:907:in `call!'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:895:in `call'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/spec/support/fake_nginx_reverse_proxy.rb:22:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-protection-1.5.3/lib/rack/protection/xss_header.rb:18:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-protection-1.5.3/lib/rack/protection/path_traversal.rb:16:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-protection-1.5.3/lib/rack/protection/json_csrf.rb:18:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-protection-1.5.3/lib/rack/protection/base.rb:49:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-protection-1.5.3/lib/rack/protection/base.rb:49:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-protection-1.5.3/lib/rack/protection/frame_options.rb:31:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-1.6.8/lib/rack/nulllogger.rb:9:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-1.6.8/lib/rack/head.rb:13:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:182:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/sinatra-1.4.7/lib/sinatra/base.rb:2013:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-test-0.6.3/lib/rack/mock_session.rb:30:in `request'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-test-0.6.3/lib/rack/test.rb:244:in `process_request'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rack-test-0.6.3/lib/rack/test.rb:76:in `put'",
             "/Users/pivotal/.rubies/ruby-2.3.3/lib/ruby/2.3.0/forwardable.rb:189:in `put'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/spec/unit/controllers/runtime/apps_controller_spec.rb:1625:in `block (4 levels) in <module:CloudController>'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:236:in `instance_exec'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:236:in `block in run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:478:in `block in with_around_and_singleton_context_hooks'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:435:in `block in with_around_example_hooks'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/hooks.rb:478:in `block in run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/hooks.rb:618:in `block in run_around_example_hooks_for'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:320:in `call'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/spec/support/database_isolation.rb:18:in `cleanly'",
             "/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:425:in `instance_exec'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:425:in `instance_exec'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/hooks.rb:389:in `execute_with'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/hooks.rb:620:in `block (2 levels) in run_around_example_hooks_for'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:320:in `call'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/hooks.rb:621:in `run_around_example_hooks_for'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/hooks.rb:478:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:435:in `with_around_example_hooks'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:478:in `with_around_and_singleton_context_hooks'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example.rb:233:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:581:in `block in run_examples'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:577:in `map'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:577:in `run_examples'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:543:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:544:in `block in run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:544:in `map'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:544:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:544:in `block in run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:544:in `map'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/example_group.rb:544:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:119:in `block (3 levels) in run_specs'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:119:in `map'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:119:in `block (2 levels) in run_specs'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/configuration.rb:1680:in `with_suite_hooks'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:118:in `block in run_specs'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/reporter.rb:77:in `report'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:117:in `run_specs'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:93:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:78:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/lib/rspec/core/runner.rb:45:in `invoke'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/rspec-core-3.4.4/exe/rspec:4:in `<top (required)>'",
             "/Users/pivotal/.gem/ruby/2.3.3/bin/rspec:22:in `load'",
             "/Users/pivotal/.gem/ruby/2.3.3/bin/rspec:22:in `<top (required)>'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli/exec.rb:74:in `load'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli/exec.rb:74:in `kernel_load'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli/exec.rb:27:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli.rb:360:in `exec'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/vendor/thor/lib/thor/command.rb:27:in `run'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/vendor/thor/lib/thor/invocation.rb:126:in `invoke_command'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/vendor/thor/lib/thor.rb:369:in `dispatch'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli.rb:20:in `dispatch'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/vendor/thor/lib/thor/base.rb:444:in `start'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli.rb:10:in `start'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/exe/bundle:35:in `block in <top (required)>'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/friendly_errors.rb:121:in `with_friendly_errors'",
             "/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/exe/bundle:27:in `<top (required)>'",
             "/Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'",
             "/Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'"
           ]
         }
       }
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:1626:in `block (4 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:18:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  3) VCAP::CloudController::AppsController create app creates the app
     Failure/Error: expect(v2_app.buildpack.url).to eq('http://example.com/buildpack')

     NoMethodError:
       undefined method `url' for "http://example.com/buildpack":String
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:362:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  4) VCAP::CloudController::AppsController create app creating a buildpack app creates the app correctly
     Failure/Error: expect(v2_app.buildpack.url).to eq('http://example.com/buildpack')

     NoMethodError:
       undefined method `url' for "http://example.com/buildpack":String
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:392:in `block (4 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  5) VCAP::CloudController::AppsController update app updates the app
     Failure/Error: expect(v2_app.buildpack.url).to eq('http://example.com/buildpack')

     NoMethodError:
       undefined method `url' for "http://example.com/buildpack":String
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:803:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  6) VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does NOT allow a public http url
     Failure/Error: app_obj.app.lifecycle_data.update(buildpack: Buildpack.make.name)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:816:in `block (4 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  7) VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does NOT allow a public git url
     Failure/Error: app_obj.app.lifecycle_data.update(buildpack: Buildpack.make.name)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:816:in `block (4 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  8) VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does allow a buildpack name
     Failure/Error: app_obj.app.lifecycle_data.update(buildpack: Buildpack.make.name)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:816:in `block (4 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  9) VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does not allow a private git url with ssh schema
     Failure/Error: app_obj.app.lifecycle_data.update(buildpack: Buildpack.make.name)

     Sequel::MassAssignmentRestriction:
       method buildpack= doesn't exist
     # ./spec/unit/controllers/runtime/apps_controller_spec.rb:816:in `block (4 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  10) VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does not allow a private git url
      Failure/Error: app_obj.app.lifecycle_data.update(buildpack: Buildpack.make.name)

      Sequel::MassAssignmentRestriction:
        method buildpack= doesn't exist
      # ./spec/unit/controllers/runtime/apps_controller_spec.rb:816:in `block (4 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
.
Finished in 4 minutes 14.5 seconds (files took 11.07 seconds to load)
1604 examples, 10 failures

Failed examples:

rspec ./spec/unit/presenters/v3/app_presenter_spec.rb:23 # VCAP::CloudController::Presenters::V3::AppPresenter#to_hash presents the app as json
rspec ./spec/unit/controllers/runtime/apps_controller_spec.rb:1624 # VCAP::CloudController::AppsController staging when app will be staged returns X-App-Staging-Log header with staging log url
rspec ./spec/unit/controllers/runtime/apps_controller_spec.rb:345 # VCAP::CloudController::AppsController create app creates the app
rspec ./spec/unit/controllers/runtime/apps_controller_spec.rb:377 # VCAP::CloudController::AppsController create app creating a buildpack app creates the app correctly
rspec ./spec/unit/controllers/runtime/apps_controller_spec.rb:780 # VCAP::CloudController::AppsController update app updates the app
rspec ./spec/unit/controllers/runtime/apps_controller_spec.rb:828 # VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does NOT allow a public http url
rspec ./spec/unit/controllers/runtime/apps_controller_spec.rb:821 # VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does NOT allow a public git url
rspec ./spec/unit/controllers/runtime/apps_controller_spec.rb:835 # VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does allow a buildpack name
rspec ./spec/unit/controllers/runtime/apps_controller_spec.rb:849 # VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does not allow a private git url with ssh schema
rspec ./spec/unit/controllers/runtime/apps_controller_spec.rb:842 # VCAP::CloudController::AppsController update app when custom buildpacks are disabled and the buildpack attribute is being changed does not allow a private git url

Randomized with seed 15375

................................................................................................

Failures:

  1) VCAP::CloudController::StagingCompletionController /build_completed propagates api errors from staging_response
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  2) VCAP::CloudController::StagingCompletionController /build_completed calls the stager with the build and response
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  3) VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS propagates other errors from staging_response
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  4) VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS propagates api errors from staging_response
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  5) VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS emits metrics for staging success
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  6) VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS calls the stager with the droplet and response
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  7) VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS when staging failed emits metrics for staging failure
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  8) VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS when staging failed passes down the sanitized version of the error to the diego stager
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  9) VCAP::CloudController::StagingCompletionController /build_completed authentication when using valid credentials succeeds
     Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

     NoMethodError:
       undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
       Did you mean?  buildpacks=
                      buildpacks
     # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  10) VCAP::CloudController::StagingCompletionController /build_completed authentication when using invalid credentials fails with authenticatiom required
      Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

      NoMethodError:
        undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
        Did you mean?  buildpacks=
                       buildpacks
      # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  11) VCAP::CloudController::StagingCompletionController /build_completed authentication when missing authentication fails with authentication required
      Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

      NoMethodError:
        undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
        Did you mean?  buildpacks=
                       buildpacks
      # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  12) VCAP::CloudController::StagingCompletionController /build_completed validation when sending invalid json fails with a 400
      Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

      NoMethodError:
        undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
        Did you mean?  buildpacks=
                       buildpacks
      # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  13) VCAP::CloudController::StagingCompletionController /build_completed when the build does not exist returns 404
      Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

      NoMethodError:
        undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
        Did you mean?  buildpacks=
                       buildpacks
      # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

  14) VCAP::CloudController::StagingCompletionController /build_completed when the start query param has a true value requests staging_complete with start
      Failure/Error: let!(:lifecycle_data) { BuildpackLifecycleDataModel.make(buildpack: buildpack, stack: 'cflinuxfs2', build: build) }

      NoMethodError:
        undefined method `buildpack=' for #<VCAP::CloudController::BuildpackLifecycleDataModel @values={}>
        Did you mean?  buildpacks=
                       buildpacks
      # ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:222:in `block (3 levels) in <module:CloudController>'
      # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
      # ./spec/support/database_isolation.rb:38:in `block in cleanly'
      # ./spec/support/database_isolation.rb:37:in `cleanly'
      # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
      # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

Finished in 4 minutes 18.4 seconds (files took 11.24 seconds to load)
1771 examples, 14 failures

Failed examples:

rspec ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:239 # VCAP::CloudController::StagingCompletionController /build_completed propagates api errors from staging_response
rspec ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:232 # VCAP::CloudController::StagingCompletionController /build_completed calls the stager with the build and response
rspec ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:298 # VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS propagates other errors from staging_response
rspec ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:290 # VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS propagates api errors from staging_response
rspec ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:282 # VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS emits metrics for staging success
rspec ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:275 # VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS calls the stager with the droplet and response
rspec ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:317 # VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS when staging failed emits metrics for staging failure
rspec ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:310 # VCAP::CloudController::StagingCompletionController /build_completed when receiving the callback directly from BBS when staging failed passes down the sanitized version of the error to the diego stager
rspec ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:364 # VCAP::CloudController::StagingCompletionController /build_completed authentication when using valid credentials succeeds
rspec ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:356 # VCAP::CloudController::StagingCompletionController /build_completed authentication when using invalid credentials fails with authenticatiom required
rspec ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:348 # VCAP::CloudController::StagingCompletionController /build_completed authentication when missing authentication fails with authentication required
rspec ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:374 # VCAP::CloudController::StagingCompletionController /build_completed validation when sending invalid json fails with a 400
rspec ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:330 # VCAP::CloudController::StagingCompletionController /build_completed when the build does not exist returns 404
rspec ./spec/unit/controllers/internal/staging_completion_controller_spec.rb:338 # VCAP::CloudController::StagingCompletionController /build_completed when the start query param has a true value requests staging_complete with start

Randomized with seed 12668

......................................................................................................................................

Failures:

  1) VCAP::CloudController::ServiceInstanceDelete#delete when deprovisioning a service instance times out should mark the service instance as failed
     Failure/Error:
       expect(a_request(:delete, deprovision_url(service_instance_1))).
         to have_been_made.times(1)

       The request DELETE https://auth_username-274:auth_password-274@foo.com/url-332/v2/service_instances/54c09a54-e668-4158-9f25-c8e819edb01c?plan_id=08dabfe3-6097-497f-a90c-bbcc54de3ec1&service_id=1038c3aa-b203-4b23-8f76-e87f013f333b was expected to execute 1 time but it executed 0 times

       The following requests were made:

       DELETE https://auth_username-274:auth_password-274@foo.com/url-332/v2/service_instances/54c09a54-e668-4158-9f25-c8e819edb01c/service_bindings/09860c67-5482-401d-bf6f-bc31ba9d1b4f?plan_id=08dabfe3-6097-497f-a90c-bbcc54de3ec1&service_id=1038c3aa-b203-4b23-8f76-e87f013f333b with headers {'Accept'=>'application/json', 'Authorization'=>'Basic YXV0aF91c2VybmFtZS0yNzQ6YXV0aF9wYXNzd29yZC0yNzQ=', 'Date'=>'Fri, 07 Jul 2017 00:39:50 GMT', 'User-Agent'=>'HTTPClient/1.0 (2.8.2.4, ruby 2.3.3 (2016-11-21))', 'X-Api-Info-Location'=>'api2.vcap.me/v2/info', 'X-Broker-Api-Version'=>'2.12', 'X-Vcap-Request-Id'=>''} was made 1 time
       DELETE https://auth_username-274:auth_password-274@foo.com/url-332/v2/service_instances/54c09a54-e668-4158-9f25-c8e819edb01c/service_bindings/4187eb65-b284-44ba-a584-dad390150711?plan_id=08dabfe3-6097-497f-a90c-bbcc54de3ec1&service_id=1038c3aa-b203-4b23-8f76-e87f013f333b with headers {'Accept'=>'application/json', 'Authorization'=>'Basic YXV0aF91c2VybmFtZS0yNzQ6YXV0aF9wYXNzd29yZC0yNzQ=', 'Date'=>'Fri, 07 Jul 2017 00:39:51 GMT', 'User-Agent'=>'HTTPClient/1.0 (2.8.2.4, ruby 2.3.3 (2016-11-21))', 'X-Api-Info-Location'=>'api2.vcap.me/v2/info', 'X-Broker-Api-Version'=>'2.12', 'X-Vcap-Request-Id'=>''} was made 1 time

       ============================================================
     # ./spec/unit/actions/services/service_instance_delete_spec.rb:188:in `block (4 levels) in <module:CloudController>'
     # ./spec/spec_helper.rb:94:in `block (3 levels) in <top (required)>'
     # ./spec/support/database_isolation.rb:38:in `block in cleanly'
     # ./spec/support/database_isolation.rb:37:in `cleanly'
     # ./spec/spec_helper.rb:94:in `block (2 levels) in <top (required)>'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
     # /Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'

Finished in 4 minutes 27.4 seconds (files took 10.15 seconds to load)
1745 examples, 1 failure

Failed examples:

rspec ./spec/unit/actions/services/service_instance_delete_spec.rb:179 # VCAP::CloudController::ServiceInstanceDelete#delete when deprovisioning a service instance times out should mark the service instance as failed

Randomized with seed 32658

...................................................

Finished in 4 minutes 53.9 seconds (files took 9.38 seconds to load)
57 examples, 0 failures

Randomized with seed 50659

Tests Failed

12685 examples, 64 failures

Took 305 seconds (5:05)
rake aborted!
Command failed with status (1): [bundle exec parallel_rspec --test-options ...]
/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/lib/tasks/spec.rake:27:in `run_specs_parallel'
/Users/pivotal/workspace/cf-release/src/capi-release/src/cloud_controller_ng/lib/tasks/spec.rake:6:in `block (2 levels) in <top (required)>'
/Users/pivotal/.gem/ruby/2.3.3/gems/rake-11.3.0/exe/rake:27:in `<top (required)>'
/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli/exec.rb:74:in `load'
/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli/exec.rb:74:in `kernel_load'
/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli/exec.rb:27:in `run'
/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli.rb:360:in `exec'
/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/vendor/thor/lib/thor/command.rb:27:in `run'
/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/vendor/thor/lib/thor/invocation.rb:126:in `invoke_command'
/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/vendor/thor/lib/thor.rb:369:in `dispatch'
/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli.rb:20:in `dispatch'
/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/vendor/thor/lib/thor/base.rb:444:in `start'
/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/cli.rb:10:in `start'
/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/exe/bundle:35:in `block in <top (required)>'
/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/lib/bundler/friendly_errors.rb:121:in `with_friendly_errors'
/Users/pivotal/.gem/ruby/2.3.3/gems/bundler-1.15.1/exe/bundle:27:in `<top (required)>'
/Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `load'
/Users/pivotal/.gem/ruby/2.3.3/bin/bundle:22:in `<main>'
Tasks: TOP => default => spec:all
(See full trace by running task with --trace)
